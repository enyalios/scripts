#!/usr/bin/perl

use strict;
use warnings;

my $progname = $0;
$progname =~ s!.*/!!;
undef $/;

my $dev = $ARGV[0] || "eth1";
my $output = `/sbin/iwlist $dev scan`;
my $wpa_file = "/etc/wpa_supplicant/wpa_supplicant.conf";
my (@data, %seen);

sub by_essid   { $a->{essid} cmp $b->{essid} || $b->{quality} <=> $a->{quality} }
sub by_quality { $b->{quality} <=> $a->{quality} || $a->{essid} cmp $b->{essid} }

open FILE, "+<$wpa_file" or die "could not open $wpa_file\n";
my $content = <FILE>;
#seek FILE, 0, 0;
truncate FILE, 0;
$content =~ s/\n# auto-generated by $progname\n.*//s;
print FILE $content;

my @access_points = split /\s*Cell \d+ - /, $output;
for(@access_points) {
    my ($address) = /^\s*Address: ([0-9A-F:]+)$/m;
    my ($essid)   = /^\s*ESSID:"(.*?)"$/m;
    my ($enc)     = /^\s*Encryption key:(\w*)$/m;
    my ($quality) = /^\s*Quality=(\d+)\/100/m;
    next unless $address && $essid && $enc && $quality;
    push @data, { address => $address, quality => $quality, essid => $essid, enc => $enc };
}

print FILE "\n# auto-generated by $progname";
for(sort by_quality @data) {
    unless($_->{enc} eq "on" or $seen{$_->{essid}}) {
        $seen{$_->{essid}} = 1;
        print FILE "\nnetwork={\n    ssid=\"", $_->{essid}, "\"\n    # ", $_->{address}, "\n    key_mgmt=NONE\n    priority=1\n}\n";
    }
}

close FILE;
