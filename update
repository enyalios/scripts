#!/bin/bash

# re-exec ourselves with sudo if not root
[[ "$UID" -ne "0" ]] && exec sudo $0 $@

JOBS=$(($(cat /proc/cpuinfo | grep MHz | wc -l) + 1))
RED=$(echo -ne "\e[1;31m")
BLUE=$(echo -ne "\e[1;34m")
CYAN=$(echo -ne "\e[1;36m")
DEFAULT=$(echo -ne "\e[0m")
MOUNTED_BOOT="0"

run_command() {
    CMD=$1
    header "$CMD"
    $CMD
    CODE=$?
    if [[ "$CODE" -ne "0" ]]; then
        echo -e "\n  ${RED}Died running '$CMD'${DEFAULT}\n"
        exit $CODE
    fi
}

check_for_new_kernel() {
    # skip kernel stuff if we arent using the gentoo-kernel package
    if ! grep -q '^sys-kernel/gentoo-kernel' /var/lib/portage/world; then
        return
    fi

    # we do the grep so messages about eselect news dont throw off the count
    if [[ "$(emerge --quiet --pretend --update gentoo-kernel | grep gentoo-kernel | wc -l)" -gt "0" ]]; then
        mount /boot 2>/dev/null
        [[ "$?" -eq  "0" ]] && MOUNTED_BOOT=1
        important "A new kernel will be installed.\n\
  Please remove the oldest one to make space\n\
  in /boot, and then press enter to continue."
        read
    fi
}

header() {
    echo "${BLUE}### $1 ${DEFAULT}"
}

important() {
    echo -e "\n  ${CYAN}$1${DEFAULT}\n"
}

check_for_new_kernel

run_command "emerge --ask --quiet-build --verbose --jobs $JOBS --update --deep --newuse @world"

find '/etc' -name '._cfg????_*' | grep -q . && header "dispatch-conf"
dispatch-conf

run_command "emerge --ask --quiet-build --verbose --jobs $JOBS @preserved-rebuild"

find '/etc' -name '._cfg????_*' | grep -q . && header "dispatch-conf"
dispatch-conf

run_command "emerge --ask --depclean"

NEWS=$(eselect news list | awk '{if($2=="N")print}')
echo "$NEWS" | grep -q . && header "eselect news list"
echo "$NEWS"

if [[ "$(uname -r)" != "$(eselect kernel list | sed -ne 's/.*linux-\([.0-9]*\) \*/\1/p')" ]]; then
    if [[ -e "/usr/sbin/grub-mkconfig" ]]; then
        run_command "grub-mkconfig -o /boot/grub/grub.cfg"
        important "New kernel installed, please reboot!"
    else
        important "New kernel installed, please edit grub config and reboot!"
    fi
fi

[[ "$MOUNTED_BOOT" -eq "1" ]] && umount /boot
# so we exit 0 even if $MOUNTED_BOOT is 0
true

# TODO
# update perl modules in ~/perl5
# remove old kernels
# keep n old kernels

# kernel removal steps
# edit grub config
# emerge -Ca gentoo-kernel-5.4.40
# rm /boot/System.map-5.4.40  /boot/config-5.4.40  /boot/initramfs-5.4.40.img  /boot/vmlinuz-5.4.40
# rm -rf /lib/modules/5.4.40
# rm -rf /usr/src/linux-5.4.40
