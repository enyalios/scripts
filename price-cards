#!/usr/bin/perl

use strict;
use warnings;
use Getopt::Std;

my %opts;
getopts('ufv', \%opts);
my $type = $opts{f}?"-foils":"";
my $debug = $opts{v}?1:0;

if($opts{u}) {
    require LWP::Simple;
    print "updating price data...\n" if -t STDOUT;

    for("", "-foils") {
        my $data = LWP::Simple::get("http://classic.magictraders.com/cgi-bin/query.cgi?list=magic$_&target=.&field=0&operator=re");
        $data =~ s/^.*<PRE>\n//s;
        $data =~ s/\n *<\/PRE>\n.*$//s;
        open(OUTPUT, ">$ENV{HOME}/magic/prices$_") or die "couldnt open output file\n";
        print OUTPUT $data;
        close OUTPUT;
    }

    exit;
}

open(FILE, "<$ENV{HOME}/magic/prices$type") or die "couldnt open prices file\n";
my @prices = <FILE>;

if(@ARGV) { # they gave us arguments to search for
    require LWP::Simple;
    my $page;
    # print out magic traders prices
    print "### MagicTraders\n";
    LINE: for(@prices) {
        for my $regex (@ARGV) { next LINE unless /$regex/i; }
        print;
    }

    # fetch and print cardshark prices
    # theres no easy way to search for foils on cardshark, so skip it
    unless($opts{f}) {
        $page = LWP::Simple::get("http://cardshark.com/Search.aspx?qu=" . join(' ', @ARGV));
        if(defined $page) {
            print "### CardShark\n";
            if($page =~ /CardShark\.com - Search for cards/) { # multiple results
                while($page =~  m!<a href="/Magic-the-Gathering/.*?">(.*?)</a></font></td><td><font color="Black"><a href="/Buy/Magic-the-Gathering/Find-Cards/.*?">(.*?)</a></font></td><td><font color="Black">.*?</font></td><td><font color="Black">.*?</font></td><td><font color="Black">(.*?)</font>!ig) {
                    my ($name, $set, $price) = ($1, $2, $3);
                    $price = "??" if $price eq "&nbsp;";
                    printf "%-30s %-30s %6s\n", $name, $set, $price;
                }
            } else { # returned a single card page
                my ($name, $set) = ($page =~ m!<span id="[^"]*_lblCardName" class="heading">(.*?)</span>.*?<span id="[^"]*_lblCardSet">(.*?)</span>!s);
                my ($price) = ($page =~ m!<tr class="tableViewRow" valign="top">\s*<td>(?:<font color="Black">)?\$([\d.]+)(?:</font>)?</td>!);
                $price = "??" if $price eq "&nbsp;";
                printf "%-30s %-30s %6s\n", $name, $set, $price;
            }
        }
    }

    # get star city games price data
    my $foil = $opts{f}?"foil":"nofoil";
    my $ssg_url = "http://sales.starcitygames.com/spoiler/display.php?name=" . join(" ", @ARGV) . "&namematch=AND&foil=$foil&for=no&display=4&numpage=100";
    print "URL: $ssg_url\n" if $debug;
    $page = LWP::Simple::get($ssg_url);
    if(defined $page) {
        my (%cards, $name, $set);
        my %code_to_digit;
#         my %offset_to_digit = qw(
#             66px   0    49.5pt 0    5.52em 0
#             0px    1    0pt    1    0em    1
#             7px    2    5pt    2    0.6em  2
#             14px   3    10.5pt 3    1.15em 3
#             21px   4    16pt   4    1.79em 4
#             28px   5    21pt   5    2.35em 5
#             35px   6    26pt   6    2.9em  6
#             42px   7    32pt   7    3.47em 7
#             49px   8    37pt   8    4.2em  8
#             56px   9    42pt   9    4.7em  9
#             63px   .    47.5pt .    5.25em .
#         );
        my %offset_to_digit = qw(
            0px    0
            7px    1
            14px   2
            21px   3
            28px   4
            35px   5
            42px   6
            49px   7
            56px   8
            63px   9
            66px   10
        );

        my $background = $1 if $page =~ /background-image:url\((.*?)\)/;
        $background = "http:" . $background unless $background =~ m!^http://!;
        my $digits = "";
        while(1) {
            print "doing the OCR loop\nbackground: $background\n" if $debug;
            $digits = &background_image_to_string($background);
            if($digits ne "") {
                last;
            } else {
                $page = LWP::Simple::get($ssg_url);
                $background = $1 if $page =~ /background-image:url\((.*?)\)/;
                $background = "http:" . $background unless $background =~ m!^http://!;
            }
        }

        # find the offset for each code and convert them to the correct digit
        while($page =~ /\.(......) {background-position:-?([\d.]+(pt|px|em))/g) {
            print "code: $1\t$2\n" if $debug;
            $code_to_digit{$1} = (exists $offset_to_digit{$2})?$offset_to_digit{$2}:"?";
        }

        for(split /<tr class="deckdbbody2?.*?">/, $page) {
            my ($price_line, $price, $count_line, $count, @cells);
            @cells = /<td class="deckdbbody2?.*?"(?: nowrap="nowrap")?>(.*?)<\/td>/sg;
            next unless @cells;
            if($cells[0] =~ /\n\s*(.*?)<\/a>/) {
                $name = $1;
                $set = $cells[1];
                $set =~ s/<.*?>//g;
                s/&amp;/&/g for $name, $set;
            }
            next if $name =~ /\(Not Tournament Legal\)/;
            for($cells[8] =~ /<div class="(.*?)">/g) {
                for(split " ", $_) {
                    s/2$//;
                    $price .= substr $digits, $code_to_digit{$_}, 1 if defined $code_to_digit{$_};
                }
            }
            # handle prices how they are listed when there is a sale
            $price = $1 if $cells[8] =~ /^.*<span[^>]*>\$([\d.]+)<\/span>/;
            $count = 0 if $cells[7] eq "Out of Stock";
            for($cells[7] =~ /<div class="(.*?)">/g) {
                for(split " ", $_) {
                    s/2$//;
                    $count .= substr $digits, $code_to_digit{$_}, 1 if defined $code_to_digit{$_};
                }
            }
            print "price: $price\tcount: $count\n" if $debug;
            $cards{$name}{$set}{count} += $count;
            $cards{$name}{$set}{min} = $price if(!defined $cards{$name}{$set}{min} || $price < $cards{$name}{$set}{min});
            $cards{$name}{$set}{max} = $price if(!defined $cards{$name}{$set}{max} || $price > $cards{$name}{$set}{max});
            #my $i = 0; print "  ", $i++, ": $_\n" for @cells;
        }

        print "### StarCityGames\n" if %cards;
        for my $name(sort keys %cards) {
            for my $set(sort keys %{$cards{$name}}) {
                printf "%-30s %-30s %6.2f  %3d\n",
                $name,
                $set,
                ($cards{$name}{$set}{min} + $cards{$name}{$set}{max}) / 2,
                $cards{$name}{$set}{count};
            }
        }
    }
} else { # no arguments, match cards on stdin
    while(<>) {
        chomp(my $card = $_);
        print grep { /^$card(,| \(.{1,4}\))/i } @prices;
    }
}

sub background_image_to_string {
    my $background = $_[0];
    my @lines = `GET "$background" | pngtopnm | gocr -C 0-9.`;
    for(@lines){ tr/ //d; chomp; }
    print "string1:  ", $lines[0], "\nstring2:  ", $lines[1], "\n" if $debug;
    my (@digits, %seen_digit);

    # make an array of digits in each row of the image
    my @digits1 = split "", $lines[0];
    my @digits2 = split "", $lines[1];

    # bail if one line is shorter than the other
    return "" unless @digits1 == @digits2;
    # or if they are both the wrong length
    return "" unless @digits1 == 11;

    # iterate thru the digits noting the ones that match
    my $max = (@digits1 > @digits2)?@digits1:@digits2;
    for(0..$max-1) {
        if($digits1[$_] eq $digits2[$_] && $digits1[$_] ne "_") {
            $digits[$_] = $digits1[$_];
            $seen_digit{$digits1[$_]} = 1;
        } else {
            $digits[$_] = "_";
        }
    }
    print "1st pass: ", join "", @digits, "\n" if $debug;

    # when one is unset pick the other if we havent used that digit anywhere else
    for(0..$max-1) {
        if($digits[$_] eq "_") {
            if($digits1[$_] eq "_" && $digits2[$_] ne "_" && !defined $seen_digit{$digits2[$_]}) {
                $digits[$_] = $digits2[$_];
                $seen_digit{$digits2[$_]} = 1;
            } elsif($digits2[$_] eq "_" && $digits1[$_] ne "_" && !defined $seen_digit{$digits1[$_]}) {
                $digits[$_] = $digits1[$_];
                $seen_digit{$digits1[$_]} = 1;
            } elsif($digits1[$_] ne "_" && $digits2[$_] ne "_" && $seen_digit{$digits1[$_]} && !defined $seen_digit{$digits2[$_]}) {
                $digits[$_] = $digits2[$_];
                $seen_digit{$digits2[$_]} = 1;
            } elsif($digits2[$_] ne "_" && $digits1[$_] ne "_" && $seen_digit{$digits2[$_]} && !defined $seen_digit{$digits1[$_]}) {
                $digits[$_] = $digits1[$_];
                $seen_digit{$digits1[$_]} = 1;
            }
        }
    }
    print "2nd pass: ", join "", @digits, "\n" if $debug;

    # we have seen every digit but 1, fill it in
    if(keys %seen_digit == 10) {
        my $missing = "";
        for(0..9, ".") {
            $missing = $_ unless defined $seen_digit{$_};
        }
        for(0..$max-1) {
            if($digits[$_] eq "_") {
                $digits[$_] = $missing;
                $seen_digit{$missing} = 1;
            }
        }
    }
    print "3rd pass: ", join "", @digits, "\n" if $debug;
    # bail unless we've seen each digit once
    return "" unless keys %seen_digit == 11;
    return join "", @digits;
}
