#!/usr/bin/perl

use strict;
use warnings;
use Getopt::Std;

my %opts;
getopts('ufc', \%opts);
my $type = $opts{f}?"-foils":"";

if($opts{u}) {
    require LWP::Simple;
    print "updating price data...\n" if -t STDOUT;

    for("", "-foils") {
        my $data = LWP::Simple::get("http://magictraders.com/cgi-bin/query.cgi?list=magic$_&target=.&field=0&operator=re");
        $data =~ s/^.*<PRE>\n//s;
        $data =~ s/\n *<\/PRE>\n.*$//s;
        open(OUTPUT, ">$ENV{HOME}/magic/prices$_") or die "couldnt open output file\n";
        print OUTPUT $data;
        close OUTPUT;
    }

    exit;
}

if($opts{c}) {
    require LWP::UserAgent;
    my $ua = LWP::UserAgent->new; 
    sub post { $ua->post($_[0], { "query" => $_[1] } )->{_content}; }
    sub get { $ua->get($_[0])->{_content}; }
    my $page = &post("http://cardshark.com/quick_search.asp", join(' ', @ARGV));
    for($page =~ m!<A HREF="(/magic/card_detail\.asp\?card_id=\d+)"!g) {
        $page = &get("http://cardshark.com$_");
        $page =~ m!</B>.*?<B>(.*?)</B>.*?</I>.*?<I>(.*?)</I>.*?Estimated Value: <B><font size="4" COLOR=".FF0000">(?:Unknown|\$(.*?))</FONT>!s;
        printf "%-30s %-30s %6s\n", $1, $2, $3?$3:"??";
    }
    exit;
}

open(FILE, "<$ENV{HOME}/magic/prices$type") or die "couldnt open prices file\n";
my @prices = <FILE>;

if(@ARGV) { # they gave us arguments to search for
    LINE: for(@prices) {
        for my $regex (@ARGV) { next LINE unless /$regex/i; }
        print;
    }
} else { # no arguments, match cards on stdin
    while(<>) {
        chomp(my $card = $_);
        print grep { /^$card(,| \(.{1,4}\))/i } @prices;
    }
}
